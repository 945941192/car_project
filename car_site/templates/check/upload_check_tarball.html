		
        {% extends 'base2/base.html' %}
        {% block title %}采集日志{% endblock %}
        {% block content %}
        <div class="page-title">
              <div class="title_left">
              </div>
        </div>

        <div class="clearfix"></div>

            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                      <h2><span style="color: #f1ad4d">手动</span>上传日志 <small>提供收集日志包的上传、检测功能。</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#">Settings 1</a>
                                </li>
                                <li><a href="#">Settings 2</a>
                                </li>
                            </ul>
                        </li>
                        <li><a class="close-link"><i class="fa fa-close"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">
                        <br />

                <form enctype="multipart/form-data" id="forms"  class="form-horizontal form-label-left" action="{% url 'check:upload_check_tarball' %}" method="post">  
                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="first-name">选择上传文件包 <span class="required">*</span></label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <input type="file"  id="Myfile" name="tarball" /> 
                        </div>
                    </div>

                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="textarea">添加备注 <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                          <textarea id="textarea" required="required" name="remarks" class="form-control col-md-7 col-xs-12" placeholder="添加备注信息"></textarea>
                        </div>
                      </div>

                    <div class="ln_solid"></div>

                    <div class="form-group">
                        <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                            <input class="btn btn-warning" id="showLoadingDiv" onclick="submit" type="button" value="upload"/>  
                        </div>
                    </div>

                    </form>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                  <div class="x_title">
                      <h2> <span style="color: #f1ad4d">自动</span>上传日志<small>填写目标主机ip、端口、密码信息自动收集并检测主机信息。</small></h2>
                    <ul class="nav navbar-right panel_toolbox">
                        <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                        </li>
                        <li class="dropdown">
                            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                            <ul class="dropdown-menu" role="menu">
                                <li><a href="#">Settings 1</a>
                                </li>
                                <li><a href="#">Settings 2</a>
                                </li>
                            </ul>
                        </li>
                        <li><a class="close-link"><i class="fa fa-close"></i></a>
                        </li>
                    </ul>
                    <div class="clearfix"></div>
                  </div>
                  <div class="x_content">

                <form enctype="multipart/form-data" id="forms_ssh"  class="form-horizontal form-label-left" action="{% url 'check:collect_remote_log' %}" method="post" ">
                  <div class='class-group' id='remote_div' >
                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12"> 有无跳板机 <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <p>
                                无:<input type="radio" class="flat" name="tag-board" id="tag-board_N" value="N" checked="" /> 
                                有:<input type="radio" class="flat" name="tag-board" id="tag-board_E" value="E" />
                            </p>
                        </div>
                    </div>
                   <div class="class-group hide" id='div_master'>
                    <div class="form-group" id='div_master_ip'>

                        <label class="control-label col-md-3 col-sm-3 col-xs-12" style="color: #f1ad4d"> 跳板机IP <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <input id="ssh_ip_master" name="ssh_ip_master" class="form-control col-md-5 col-xs-12" placeholder='Please enter the IP address'/>
                        </div>
                    </div>
                    <div class="form-group" id='div_master_port'>
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" style="color: #f1ad4d"> 端口 <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <input id="ssh_port_master" name="ssh_port_master" class="form-control col-md-5 col-xs-12" placeholder='Please enter theport information'/>
                        </div>
                    </div>
                    <div class="form-group" id='div_master_passwd'>
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" style="color: #f1ad4d"> 密码 <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <input type="password" name="passwd_master_ssh" id="passwd_master_ssh" class="form-control"  placeholder='Please enter password'>
                        </div>
                    </div>

                    <div class="ln_solid" id='div_master_solid'></div>
                    </div>
                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12"> 目标主机IP <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <input id="ssh_ip_slave" name="ssh_ip_slave" class="form-control col-md-5 col-xs-12" placeholder='Please enter the IP address'/>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12"> 端口 <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <input id="ssh_port_slave" name="ssh_port_slave" class="form-control col-md-5 col-xs-12" placeholder='Please enter theport information'/>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12"> 密码 <span class="required">*</span></label>
                        <div class="col-md-3 col-sm-6 col-xs-12">
                            <input type="password" name="passwd_slave_ssh" id="passwd_slave_ssh" class="form-control"  placeholder='Please enter password'>
                        </div>
                    </div>

                    <div class="item form-group">
                        <label class="control-label col-md-3 col-sm-3 col-xs-12" for="textarea">添加备注 <span class="required">*</span>
                        </label>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <textarea id="remarks_ssh" required="required" name="remarks_ssh" class="form-control col-md-7 col-xs-12" placeholder="添加备注信息"></textarea>
                        </div>
                    </div>

                    <div class="ln_solid"></div>

                    <div class="form-group">
                        <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                            <input class="btn btn-warning" id="showLoadingDiv_ssh" onclick="submit" type="button" value="upload"/>  
                        </div>
                    </div>
                 </div>
                </form>
                  </div>
                </div>
              </div>
            </div>
           </div>
        <div class="row">
            <div class="col-md-12 col-sm-12 col-xs-12">
                <div class="x_panel">
                    <div class="x_title">
                        <h2>展示 <small>提供收集日志包的下载、展示检查报告功能。</small></h2>
                        <ul class="nav navbar-right panel_toolbox">
                            <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                                <ul class="dropdown-menu" role="menu">
                                </ul>
                            </li>
                            <li><a class="close-link"><i class="fa fa-close"></i></a>
                            </li>
                        </ul>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <p class="text-muted font-13 m-b-30"></p>

                        <table id="example" class="table table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>                         
                            <tr>                            
                                <th style="text-align:center;width:20%;vertical-align: middle;"> tarball info</th>                
                                <th style="text-align:center;width:5%">report</th>      
                                <th style="text-align:center;width:5%">tarball</th>      
                                <th style="text-align:center;width:30%">时间</th>                   
                                <th id="test" style="text-align:center;width:40%"> 备注信息</th>                
                            </tr>                           
                            </thead>                                                                                                                                               
                            <tbody>                         
                            {%for info in tarball_set%}     
                                <tr>                            
                                    <td style="text-align:center;vertical-align: middle;">{{info.file_name}}</td>
                                    {% if info.check_status == 1 %}
                                    <td style="text-align:center;"><button class="btn btn-warning" type="button"  onclick="show_oss_report('{{info.check_report_url}}')">查看</button></td>    
                                    {% else %}
                                        <td style="text-align:center;"><button class="btn btn-primary" type="button" disabled="disabled" onclick="window.open('{{info.check_report_url}}')">查看</button></td>    
                                    {% endif %}

                                    {% if info.check_status == 1 %}
                                        <td style="text-align:center;"><button class="btn btn-round btn-warning" type="button" onclick="window.open('{{info.tarball_url}}')">下载</button></td>    
                                    {% else %}
                                        <td style="text-align:center;"><button class="btn btn-info" type="button" disables="disabled" onclick="window.open('{{info.tarball_url}}')">下载</button></td>    
                                    {% endif %}
                                    <td style="text-align:center; vertical-align: middle;">{{ info.upload_time|date:"Y-m-d H:i:s" }}</td> 
                                    {% if info.remarks == '' %}
                                        <td>无</td>
                                    {% else %}
                                        <td class="remarks">{{info.remarks}}</td>
                                    {% endif %}
                                </tr>                           
                            {%endfor%}                      
                            </tbody>                        
                  
                        </table>      

                  </div>
                </div>
              </div>
            </div>

            <div class="am-u-md-41" id="up_loading" style="text-align:center;margin-top: 211px;display:none"  align="center">
                <img src="/static/images/boy_loading.gif"  style="text-align:center" alt="system_process-img" class="img-rounded"> 
                <h3>   玩命上传中，请稍等。。。。。。</h3>
            </div>

        {% endblock %}

        {% block extrajs %}
		<script type="text/javascript">
            function show_oss_report(full_link){ 
                window.open("{% url 'check:show_oss_report' %}"+"?oss_report_url="+full_link)
            }

        $(document).ready(function() {
            $("#showLoadingDiv").click(function(){
                var upload_file_name = $("#Myfile").val();
                var remarks = $("#remarks").val();
                var re_file_name = new RegExp(/\.tar\.gz$/);
                if (!upload_file_name){
                    alert("请选择要检测的tarball");
                    return false;
                }
                else if(!re_file_name.test(upload_file_name)){
                     alert("请输入正确的tarball 如:cloud_log.2017-10-20-16-54-51.tar.gz")   
                } else if( remarks == '' ){
                     alert("请输入备注信息");
                     return false;
                } else{
                    $(".row").hide()
                    $("#up_loading").show()
                    $("#forms").submit();
                }
                });
                //文本原样呈现
                $(".remarks").each(function(){
                    $(this).html($(this).text().replace(/\n/g,'<br>'))
                });
                //有无跳板机 单选按钮点击js
                $('#remote_div input:radio[id^="tag-board"]').on('ifChecked',function(event){
                     if ($(this).is(":checked")) {
                         if ($(this).val() == 'N') {
                            $('#remote_div div[id="div_master"]').addClass("hide");                       
                            $('#ssh_ip_master').val('')
                            $('#ssh_port_master').val('')
                            $('#passwd_master_ssh').val('')
                       } else {
                            $('#remote_div div[id="div_master"]').removeClass("hide");
                       }
                  }
                });

            //自动上传按钮的点击操作响应函数
            $("#showLoadingDiv_ssh").click(function(){
                var filename = $('#remote_div input[name^="ssh_"]');
                var flag = 1;
                $.each(filename,function(k,file){
                 if ($('#tag-board_E').is(":checked")) {
                  if(file.value == ''){
                     alert('IP和port不能留空');
                     flag = 0;
                     return false;
                   } else if(/(^ssh_port_)/.test($(this).attr('id'))){
                        var reg = /^[0-9]+.?[0-9]*$/;
                         if (!(reg.test($(this).val()))) {
                           alert('端口请输入纯数字格式');
                           flag = 0; 
                           return false;
                         }
                   } else if(/(^ssh_ip_)/.test($(this).attr('id')))  {    
                       var is_ip = isIP($(this).val());
                       if (!is_ip){ 
                         alert('无效IP:'+$(this).val()+'，请检查更正，谢谢！');
                         flag = 0;
                         return false;
                       }
                   } 
                  } else if ($('#tag-board_N').is(":checked")) {
                       if (/(^ssh.*slave$)/.test($(this).attr('id'))) {
                         if(file.value == ''){
                            alert('目标主机IP和port不能留空');
                            flag = 0;
                            return false; 
                         } else if(/(ssh_port_slave)/.test($(this).attr('id'))){
                            var reg = /^[0-9]+.?[0-9]*$/;
                            if (!(reg.test($(this).val()))) {
                               alert('目标主机端口请输入纯数字格式');
                               flag = 0; 
                               return false;
                            }
                         } else if(/(ssh_ip_slave)/.test($(this).attr('id')))  { 
                            var is_ip = isIP($(this).val());
                            if (!is_ip){ 
                               alert('无效目标机IP:'+$(this).val()+'，请检查更正，谢谢！');
                               flag = 0;
                               return false; 
                           } 
                         }                         
                       }
                  }
                });
                 if (flag == 0) {
                     flag = 1;
                     return false;
                 }
                    $(".row").hide()
                    $("#up_loading").show()               
                    $("#forms_ssh").submit();
            });
                 // 用于匹配正确的IP 比如过滤掉 192.168.1.256
                 function isIP(ip){
                         var reSpaceCheck = /^(\d+)\.(\d+)\.(\d+)\.(\d+)$/;
                     if (reSpaceCheck.test(ip)){
                         ip.match(reSpaceCheck);
                         if (RegExp.$1<=255&&RegExp.$1>=0 && RegExp.$2<=255 && RegExp.$2>=0 && RegExp.$3<=255&&RegExp.$3>=0 && RegExp.$4<=255&&RegExp.$4>=0){
                             return true;
                         }else{
                             return false;
                         }
                     }else{ 
                         return false;
                     }
                    }
        });

        $(document).ready(function() {
            $('#example').DataTable( {
                "order": [[ 3, "desc"  ]],
                "createdRow": function( row, data, dataIndex ) {
                    $(row).children('td').eq(0).attr('style', 'text-align: center; vertical-align: middle;')
                    $(row).children('td').eq(1).attr('style', 'text-align: center; vertical-align: middle;')
                    $(row).children('td').eq(2).attr('style', 'text-align: center; vertical-align: middle;')
                    $(row).children('td').eq(3).attr('style', 'text-align: center; vertical-align: middle;')
                    $(row).children('td').eq(4).attr('style', 'vertical-align: middle;')
                },
            });
 
        });

    </script>
    {% endblock %}
